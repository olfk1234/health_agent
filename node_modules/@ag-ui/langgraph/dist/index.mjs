var pt=Object.defineProperty,mt=Object.defineProperties;var Et=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var St=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable;var tt=(a,t)=>(t=Symbol[a])?t:Symbol.for("Symbol."+a);var et=(a,t,e)=>t in a?pt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,p=(a,t)=>{for(var e in t||(t={}))St.call(t,e)&&et(a,e,t[e]);if(Z)for(var e of Z(t))vt.call(t,e)&&et(a,e,t[e]);return a},f=(a,t)=>mt(a,Et(t));var nt=(a,t,e)=>(t=a[tt("asyncIterator")])?t.call(a):(a=a[tt("iterator")](),t={},e=(s,n)=>(n=a[s])&&(t[s]=r=>new Promise((c,h,l)=>(r=n.call(a,r),l=r.done,Promise.resolve(r.value).then(E=>c({value:E,done:l}),h)))),e("next"),e("return"),t);import{HttpAgent as Ct}from"@ag-ui/client";import{Observable as _t}from"rxjs";import{Client as Tt}from"@langchain/langgraph-sdk";import{randomUUID as Mt}from"crypto";import{RemoveMessage as Rt}from"@langchain/core/messages";var ft=(d=>(d.OnChainStart="on_chain_start",d.OnChainStream="on_chain_stream",d.OnChainEnd="on_chain_end",d.OnChatModelStart="on_chat_model_start",d.OnChatModelStream="on_chat_model_stream",d.OnChatModelEnd="on_chat_model_end",d.OnToolStart="on_tool_start",d.OnToolEnd="on_tool_end",d.OnCustomEvent="on_custom_event",d.OnInterrupt="on_interrupt",d))(ft||{}),yt=(n=>(n.ManuallyEmitMessage="manually_emit_message",n.ManuallyEmitToolCall="manually_emit_tool_call",n.ManuallyEmitState="manually_emit_state",n.Exit="exit",n))(yt||{});import{AbstractAgent as It,EventType as i}from"@ag-ui/client";var P=["tools"];function O(a,t){return Object.fromEntries(Object.entries(a).filter(([e])=>t.includes(e)))}function st({mode:a,state:t,schemaKeys:e}){let s=a==="start"?t:null;return s&&(e!=null&&e.input)&&(s=O(s,[...P,...e.input])),s}function at(a){return a.map(t=>{var e;switch(t.type){case"human":return{id:t.id,role:"user",content:k(M(t.content))};case"ai":let s=M(t.content);return{id:t.id,role:"assistant",content:s?k(s):"",toolCalls:(e=t.tool_calls)==null?void 0:e.map(n=>({id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}))};case"system":return{id:t.id,role:"system",content:k(M(t.content))};case"tool":return{id:t.id,role:"tool",content:k(M(t.content)),toolCallId:t.tool_call_id};default:throw new Error("message type returned from LangGraph is not supported.")}})}function it(a){return a.map((t,e)=>{var s,n;switch(t.role){case"user":return{id:t.id,role:t.role,content:t.content,type:"human"};case"assistant":return{id:t.id,type:"ai",role:t.role,content:(s=t.content)!=null?s:"",tool_calls:((n=t.toolCalls)!=null?n:[]).map(r=>({id:r.id,name:r.function.name,args:JSON.parse(r.function.arguments),type:"tool_call"}))};case"system":return{id:t.id,role:t.role,content:t.content,type:"system"};case"tool":return{content:t.content,role:t.role,type:t.role,tool_call_id:t.toolCallId,id:t.id};default:throw console.error(`Message role ${t.role} is not implemented`),new Error("message role is not supported.")}})}function k(a){return typeof a=="string"?a:JSON.stringify(a)}function rt(a){var e,s,n,r,c;let t=(e=a.chunk)==null?void 0:e.content;if(t&&Array.isArray(t)&&t.length&&t[0])return t[0].thinking?{text:t[0].thinking,type:"text",index:t[0].index}:null;if((r=(n=(s=a.chunk.additional_kwargs)==null?void 0:s.reasoning)==null?void 0:n.summary)!=null&&r[0]){let h=(c=a.chunk.additional_kwargs)==null?void 0:c.reasoning.summary[0];return!h||!h.text?null:{type:"text",text:h.text,index:h.index}}return null}function M(a){var t;if(!a)return null;if(typeof a=="string")return a;if(Array.isArray(a)&&a.length){let e=(t=a.find(s=>s.type==="text"))==null?void 0:t.text;return e!=null?e:null}return null}var ot=class extends It{constructor(t){var e,s;super(t),this.messagesInProcess={},this.agentName=t.agentName,this.graphId=t.graphId,this.assistantConfig=t.assistantConfig,this.thinkingProcess=null,this.client=(s=t==null?void 0:t.client)!=null?s:new Tt({apiUrl:t.deploymentUrl,apiKey:t.langsmithApiKey,defaultHeaders:p({},(e=t.propertyHeaders)!=null?e:{})})}dispatchEvent(t){return this.subscriber.next(t),!0}run(t){return this.activeRun={id:t.runId,threadId:t.threadId},new _t(e=>(this.handleStreamEvents(t,e),()=>{}))}async handleStreamEvents(t,e){var K,U,J,X,F,j,B,$,Y,V,W,q,z;let{threadId:s,state:n,messages:r,tools:c,context:h,forwardedProps:l}=t;this.subscriber=e;let E=!1;this.activeRun.manuallyEmittedState=null;let d=l==null?void 0:l.nodeName;this.activeRun.nodeName=d,this.activeRun.nodeName==="__end__"&&(this.activeRun.nodeName=void 0);let o=s!=null?s:Mt();this.assistant||(this.assistant=await this.getAssistant());let v=await this.getOrCreateThread(o,l==null?void 0:l.threadMetadata);this.activeRun.threadId=v.thread_id;let g=(K=await this.client.threads.getState(v.thread_id))!=null?K:{values:{}},w=g.values,L=it(r);n.messages=w.messages,n=this.langGraphDefaultMergeState(n,L,c);let N=await this.client.assistants.getGraph(this.assistant.assistant_id),x=o&&this.activeRun.nodeName!="__end__"&&this.activeRun.nodeName?"continue":"start";if(x==="continue"&&!((U=l==null?void 0:l.command)!=null&&U.resume)){let u=N.edges.find(y=>y.target===this.activeRun.nodeName);await this.client.threads.updateState(o,{values:n,asNode:u==null?void 0:u.source})}this.activeRun.schemaKeys=await this.getSchemaKeys();let R=st({mode:x,state:n,schemaKeys:this.activeRun.schemaKeys}),I,C=[this.assistantConfig,l==null?void 0:l.config].filter(Boolean);C.length&&(I=await this.mergeConfigs({configs:C,assistant:this.assistant,schemaKeys:this.activeRun.schemaKeys}));let A=f(p({},l),{streamMode:(J=l==null?void 0:l.streamMode)!=null?J:["events","values","updates"],input:R,config:I}),S=(j=(F=(X=g.tasks)==null?void 0:X[0])==null?void 0:F.interrupts)!=null?j:[];if(S!=null&&S.length&&!((B=l==null?void 0:l.command)!=null&&B.resume))return this.dispatchEvent({type:i.RUN_STARTED,threadId:o,runId:t.runId}),S.forEach(u=>{this.dispatchEvent({type:i.CUSTOM,name:"on_interrupt",value:typeof u.value=="string"?u.value:JSON.stringify(u.value),rawEvent:u})}),this.dispatchEvent({type:i.RUN_FINISHED,threadId:o,runId:t.runId}),e.complete();let dt=this.client.runs.stream(o,this.assistant.assistant_id,A);this.activeRun.prevNodeName=null;let H={},G=n;try{this.dispatchEvent({type:i.RUN_STARTED,threadId:o,runId:this.activeRun.id});try{for(var Te=nt(dt),Me,Re,Ie;Me=!(Re=await Te.next()).done;Me=!1){let m=Re.value;if(!A.streamMode.includes(m.event))continue;let D=m;if(m.event==="error"){this.dispatchEvent({type:i.RUN_ERROR,message:m.data.message,rawEvent:m});break}if(m.event==="updates")continue;if(m.event==="values"){H=D.data;continue}let _=D.data,T=_.metadata.langgraph_node,Q=_.event,ct=_.metadata;if(this.activeRun.id=ct.run_id,T&&T!==this.activeRun.nodeName&&(this.activeRun.nodeName&&this.activeRun.nodeName!==d&&this.endStep(),this.startStep(T)),E=E||Q==="on_custom_event"&&_.name==="exit",this.activeRun.exitingNode=this.activeRun.nodeName===T&&Q==="on_chain_end",this.activeRun.exitingNode&&(this.activeRun.manuallyEmittedState=null),N.nodes.some(ut=>ut.id===T)&&(this.activeRun.nodeName=T),G=($=this.activeRun.manuallyEmittedState)!=null?$:H,!this.activeRun.nodeName)continue;(JSON.stringify(G)!==JSON.stringify(n)||this.activeRun.prevNodeName!=this.activeRun.nodeName||this.activeRun.exitingNode)&&!this.getMessageInProgress(this.activeRun.id)&&(n=G,this.activeRun.prevNodeName=this.activeRun.nodeName,this.dispatchEvent({type:i.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(n),rawEvent:D})),this.dispatchEvent({type:i.RAW,event:_}),this.handleSingleEvent(_,n)}}catch(Re){Ie=[Re]}finally{try{Me&&(Re=Te.return)&&await Re.call(Te)}finally{if(Ie)throw Ie[0]}}n=await this.client.threads.getState(o);let u=n.tasks,y=(V=(Y=u==null?void 0:u[0])==null?void 0:Y.interrupts)!=null?V:[],ht=n.next.length===0,gt=(W=n.metadata.writes)!=null?W:{},b=this.activeRun.nodeName;return y!=null&&y.length||(b=ht?"__end__":(q=n.next[0])!=null?q:Object.keys(gt)[0]),y.forEach(m=>{this.dispatchEvent({type:i.CUSTOM,name:"on_interrupt",value:typeof m.value=="string"?m.value:JSON.stringify(m.value),rawEvent:m})}),this.activeRun.nodeName!=b&&(this.endStep(),this.startStep(b)),this.endStep(),this.dispatchEvent({type:i.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(n.values)}),this.dispatchEvent({type:i.MESSAGES_SNAPSHOT,messages:at((z=n.values.messages)!=null?z:[])}),this.dispatchEvent({type:i.RUN_FINISHED,threadId:o,runId:this.activeRun.id}),this.activeRun=void 0,e.complete()}catch(u){return e.error(u)}}handleSingleEvent(t,e){var s,n,r,c,h,l;switch(t.event){case"on_chat_model_stream":let E=(s=t.metadata["emit-messages"])!=null?s:!0,d=(n=t.metadata["emit-tool-calls"])!=null?n:!0;if(t.data.chunk.response_metadata.finish_reason)return;let o=this.getMessageInProgress(this.activeRun.id),v=!!(o!=null&&o.id),g=(r=t.data.chunk.tool_call_chunks)==null?void 0:r[0],w=(c=t.metadata.predict_state)==null?void 0:c.some(S=>S.tool===(g==null?void 0:g.name)),L=!v&&(g==null?void 0:g.name),N=v&&(o==null?void 0:o.toolCallId)&&(g==null?void 0:g.args),x=v&&(o==null?void 0:o.toolCallId)&&!g,R=rt(t.data),I=M(t.data.chunk.content),C=!!(!g&&I),A=v&&!(o!=null&&o.toolCallId)&&!C;if(R){this.handleThinkingEvent(R);break}if(!R&&this.thinkingProcess&&(this.dispatchEvent({type:i.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:i.THINKING_END}),this.thinkingProcess=null),w&&this.dispatchEvent({type:i.CUSTOM,name:"PredictState",value:t.metadata.predict_state}),x){this.dispatchEvent({type:i.TOOL_CALL_END,toolCallId:o==null?void 0:o.toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(A){this.dispatchEvent({type:i.TEXT_MESSAGE_END,messageId:o.id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(L&&d){this.dispatchEvent({type:i.TOOL_CALL_START,toolCallId:g.id,toolCallName:g.name,parentMessageId:t.data.chunk.id,rawEvent:t})&&this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:g.id,toolCallName:g.name});break}if(N&&d){this.dispatchEvent({type:i.TOOL_CALL_ARGS,toolCallId:o==null?void 0:o.toolCallId,delta:g.args,rawEvent:t});break}if(C&&E){o||(this.dispatchEvent({type:i.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.chunk.id,rawEvent:t}),this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:null,toolCallName:null}),o=this.getMessageInProgress(this.activeRun.id)),this.dispatchEvent({type:i.TEXT_MESSAGE_CONTENT,messageId:o.id,delta:I,rawEvent:t});break}break;case"on_chat_model_end":if((h=this.getMessageInProgress(this.activeRun.id))!=null&&h.toolCallId){this.dispatchEvent({type:i.TOOL_CALL_END,toolCallId:this.getMessageInProgress(this.activeRun.id).toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if((l=this.getMessageInProgress(this.activeRun.id))!=null&&l.id){this.dispatchEvent({type:i.TEXT_MESSAGE_END,messageId:this.getMessageInProgress(this.activeRun.id).id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}break;case"on_custom_event":if(t.name==="manually_emit_message"){this.dispatchEvent({type:i.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.message_id,rawEvent:t}),this.dispatchEvent({type:i.TEXT_MESSAGE_CONTENT,messageId:t.data.message_id,delta:t.data.message,rawEvent:t}),this.dispatchEvent({type:i.TEXT_MESSAGE_END,messageId:t.data.message_id,rawEvent:t});break}if(t.name==="manually_emit_tool_call"){this.dispatchEvent({type:i.TOOL_CALL_START,toolCallId:t.data.id,toolCallName:t.data.name,parentMessageId:t.data.id,rawEvent:t}),this.dispatchEvent({type:i.TOOL_CALL_ARGS,toolCallId:t.data.id,delta:t.data.args,rawEvent:t}),this.dispatchEvent({type:i.TOOL_CALL_END,toolCallId:t.data.id,rawEvent:t});break}t.name==="manually_emit_state"&&(this.activeRun.manuallyEmittedState=t.data,this.dispatchEvent({type:i.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(e),rawEvent:t})),this.dispatchEvent({type:i.CUSTOM,name:t.name,value:t.data,rawEvent:t});break}}handleThinkingEvent(t){var s;if(!t||!t.type||!t.text)return;let e=t.index;(s=this.thinkingProcess)!=null&&s.index&&this.thinkingProcess.index!==e&&(this.thinkingProcess.type&&this.dispatchEvent({type:i.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:i.THINKING_END}),this.thinkingProcess=null),this.thinkingProcess||(this.dispatchEvent({type:i.THINKING_START}),this.thinkingProcess={index:e}),this.thinkingProcess.type!==t.type&&(this.dispatchEvent({type:i.THINKING_TEXT_MESSAGE_START}),this.thinkingProcess.type=t.type),this.thinkingProcess.type&&this.dispatchEvent({type:i.THINKING_TEXT_MESSAGE_CONTENT,delta:t.text})}getStateSnapshot(t){let e=this.activeRun.schemaKeys;return e!=null&&e.output&&(t=O(t,[...P,...e.output])),t}async getOrCreateThread(t,e){let s;try{try{s=await this.getThread(t)}catch(n){s=await this.createThread({threadId:t,metadata:e})}}catch(n){throw new Error(`Failed to create thread: ${n.message}`)}return s}async getThread(t){return this.client.threads.get(t)}async createThread(t){return this.client.threads.create(t)}async mergeConfigs({configs:t,assistant:e,schemaKeys:s}){return t.reduce((n,r)=>{var o;let c=n.configurable;r.configurable&&(c=s!=null&&s.config?O(r==null?void 0:r.configurable,[...P,...(o=s==null?void 0:s.config)!=null?o:[]]):r==null?void 0:r.configurable);let h=f(p(p({},n),r),{configurable:c}),l=n.recursion_limit==null&&r.recursion_limit===25,E=JSON.stringify(h)!==JSON.stringify(n),d=l&&JSON.stringify(f(p({},h),{recursion_limit:null}))===JSON.stringify(f(p({},n),{recursion_limit:null}));return E&&!d?p(p({},n),h):n},e.config)}getMessageInProgress(t){return this.messagesInProcess[t]}setMessageInProgress(t,e){this.messagesInProcess=f(p({},this.messagesInProcess),{[t]:p(p({},this.messagesInProcess[t]),e)})}async getAssistant(){let t=await this.client.assistants.search(),e=t.find(s=>s.graph_id===this.graphId);if(!e)throw console.error(`
      No agent found with graph ID ${this.graphId} found..

      
      These are the available agents: [${t.map(s=>`${s.graph_id} (ID: ${s.assistant_id})`).join(", ")}]
      `),new Error("No agent id found");return e}async getSchemaKeys(){var e,s,n;let t=["messages"];try{let r=await this.client.assistants.getSchemas(this.assistant.assistant_id),c=null;if((e=r.config_schema)!=null&&e.properties&&(c=Object.keys(r.config_schema.properties)),!((s=r.input_schema)!=null&&s.properties)||!((n=r.output_schema)!=null&&n.properties))return{config:[],input:t,output:t};let h=Object.keys(r.input_schema.properties),l=Object.keys(r.output_schema.properties);return{input:h&&h.length?[...h,...t]:null,output:l&&l.length?[...l,...t]:null,config:c}}catch(r){return{config:[],input:t,output:t}}}langGraphDefaultMergeState(t,e,s){var E;e.length>0&&"role"in e[0]&&e[0].role==="system"&&(e=e.slice(1));let n=t.messages||[],r=new Set(n.map(d=>d.id)),c=new Set(e.map(d=>d.id)),h=[];e.length<n.length&&(h=n.filter(d=>!c.has(d.id)).map(d=>new Rt({id:d.id})));let l=e.filter(d=>!r.has(d.id));return f(p({},t),{messages:[...h,...l],tools:[...(E=t.tools)!=null?E:[],...s]})}startStep(t){this.dispatchEvent({type:i.STEP_STARTED,stepName:t}),this.activeRun.nodeName=t}endStep(){if(!this.activeRun.nodeName)throw new Error("No active step to end");this.dispatchEvent({type:i.STEP_FINISHED,stepName:this.activeRun.nodeName}),this.activeRun.nodeName=void 0}};var lt=class extends Ct{};export{yt as CustomEventNames,ot as LangGraphAgent,ft as LangGraphEventTypes,lt as LangGraphHttpAgent};
//# sourceMappingURL=index.mjs.map